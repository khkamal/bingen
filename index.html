<!DOCTYPE html>
<html>
<head>
<title>BIN Gen + Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Monetag SDK -->
<script src='//libtl.com/sdk.js' data-zone='10218802' data-sdk='show_10218802'></script>

<style>
body{
  font-family: Arial, sans-serif; padding:15px;
  background:#111; color:#fff;
}
.box{
  background:#222; padding:15px; border-radius:10px; margin-bottom:15px;
}
button{
  padding:10px 15px; border:none; border-radius:8px;
  background:#0af; color:#000; font-weight:bold;
}
input{
  padding:10px; width:100%; border-radius:6px;
  border:none; margin-bottom:10px;
}
.admin{
  background:#440000;
}
</style>
</head>
<body>

<h2>BIN Generator + Wallet</h2>

<div id="userInfo" class="box">Checking user...</div>

<div class="box">
  <h3>Your Coins: <span id="coins">0</span></h3>
  <button onclick="showReward()">Watch Ad +20 Coins</button>
</div>

<div class="box">
  <h3>Generate BIN</h3>
  <button onclick="generateBIN()">Generate</button>
  <pre id="binBox"></pre>
</div>

<div id="adminPanel" class="box admin" style="display:none;">
  <h3>Admin Panel</h3>
  <button onclick="loadUsers()">Load Users</button>
  <div id="userList"></div>
</div>

<script type="module">

// ------------------- Firebase --------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, set, update, get, child } 
from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDnAOm7qFRHpEzDEnG0oITF9GFO2DRpTDE",
  authDomain: "bin-gen-3de39.firebaseapp.com",
  databaseURL: "https://bin-gen-3de39-default-rtdb.firebaseio.com",
  projectId: "bin-gen-3de39",
  storageBucket: "bin-gen-3de39.firebasestorage.app",
  messagingSenderId: "892904057114",
  appId: "1:892904057114:web:76e28b35f183b7417b24a3",
  measurementId: "G-PGLCZ35JK1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ------------------- TG Mini App --------------------
let tg = window.Telegram?.WebApp;
let uid = tg ? tg.initDataUnsafe.user.id : "NO_TG_USER";

// আপনার দেয়া UID admin হিসেবে সেট
const adminUID = "WrL62ZpiYyXCRLDVMQ8IRmZTga12";

// ------------------- User Create / Load --------------------
async function loadUser(){
  const dbRef = ref(db);
  const snap = await get(child(dbRef, `users/${uid}`));

  if(!snap.exists()){
    await set(ref(db, `users/${uid}`), {
      coins:100,
      created_at: new Date().toISOString().slice(0,10),
      role: uid===adminUID ? "admin" : "user"
    });
  }

  return (await get(child(dbRef, `users/${uid}`))).val();
}

let userData = await loadUser();
document.getElementById("coins").innerText = userData.coins;
document.getElementById("userInfo").innerHTML = 
  `UID: ${uid}<br>Role: ${userData.role}<br>Coins: ${userData.coins}`;

// Show admin panel
if(userData.role === "admin"){
  document.getElementById("adminPanel").style.display="block";
}

// ------------------- Watch Ad --------------------
function showReward(){
  show_10218802().then(async ()=>{
    let newCoins = userData.coins + 20;
    update(ref(db, `users/${uid}`), {coins:newCoins});
    userData.coins = newCoins;
    document.getElementById("coins").innerText = newCoins;
    alert("20 Coins Added!");
  });
}

// ------------------- BIN Generator --------------------
function randomNum(n){ return Math.floor(Math.random()*10**n).toString().padStart(n,'0'); }

function generateBIN(){
  let prefix = "472068"; // fixed
  let card = prefix + randomNum(10);
  document.getElementById("binBox").innerText = card;
}

// ------------------- Admin Panel Functions --------------------
async function loadUsers(){
  const snap = await get(ref(db, "users"));
  if(!snap.exists()) return;
  let data = snap.val();
  let html = "";

  Object.keys(data).forEach(uid=>{
    html += `
      <div class='box'>
        <b>UID:</b> ${uid}<br>
        Coins: ${data[uid].coins}<br>
        Role: ${data[uid].role}<br>
        <button onclick="addCoin('${uid}')">+10 Coin</button>
        <button onclick="removeCoin('${uid}')">-10 Coin</button>
        <button onclick="banUser('${uid}')">Ban</button>
      </div>
    `;
  });

  document.getElementById("userList").innerHTML = html;
}

window.addCoin = async function(target){
  let userSnap = await get(ref(db, `users/${target}`));
  let c = userSnap.val().coins + 10;
  update(ref(db, `users/${target}`), {coins:c});
  loadUsers();
}

window.removeCoin = async function(target){
  let userSnap = await get(ref(db, `users/${target}`));
  let c = userSnap.val().coins - 10;
  if(c<0) c=0;
  update(ref(db, `users/${target}`), {coins:c});
  loadUsers();
}

window.banUser = async function(target){
  update(ref(db, `users/${target}`), {role:"banned"});
  loadUsers();
}

</script>
</body>
</html>
